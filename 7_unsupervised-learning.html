<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.475">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Johannes B. Gruber">
<meta name="dcterms.date" content="2023-03-28">

<title>Session 7: Unsupervised Machine Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="7_unsupervised-learning_files/libs/clipboard/clipboard.min.js"></script>
<script src="7_unsupervised-learning_files/libs/quarto-html/quarto.js"></script>
<script src="7_unsupervised-learning_files/libs/quarto-html/popper.min.js"></script>
<script src="7_unsupervised-learning_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="7_unsupervised-learning_files/libs/quarto-html/anchor.min.js"></script>
<link href="7_unsupervised-learning_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="7_unsupervised-learning_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="7_unsupervised-learning_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="7_unsupervised-learning_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="7_unsupervised-learning_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Session 7: Unsupervised Machine Learning</h1>
<p class="subtitle lead">Textanalyse in R: eine Einführung</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Johannes B. Gruber </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 28, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>LDA, which stands for Latent Dirichlet Allocation, is one of the most popular approaches for probabilistic topic modeling. The goal of topic modeling is to automatically assign topics to documents without requiring human supervision. Although the idea of an algorithm figuring out topics might sound close to magical (mostly because people have too high expectations of what these ‘topics’ are), and the mathematics might be a bit challenging, it is actually really simple fit an LDA topic model in R.</p>
<p>A good first step towards understanding what topic models are and how they can be useful, is to simply play around with them, so that’s what we’ll do first.</p>
</section>
<section id="playful-exploration" class="level1">
<h1>Playful exploration<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></h1>
<p>Open the page <a href="https://lettier.com/projects/lda-topic-modeling/" class="uri">https://lettier.com/projects/lda-topic-modeling/</a> (if possible, in Firefox)</p>
<p>Example Docs:</p>
<ol type="1">
<li>🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭</li>
<li>🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱</li>
<li>🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶</li>
<li>🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐭 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐱 🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶 🐶</li>
</ol>
<p>On top, the texts are turned into a document feature matrix.</p>
<p><img src="media/lda-dfm.png" class="img-fluid"></p>
<p>What LDA does is essentially to reduce the dimensions of a text into a set of ‘topics’ that are easier to interpret. It then expresses the relation between cases and topics, as well as variables and topics in two matrices. If you have used PCA, MDS or factor analysis before, this is essentially the same process.</p>
<p>The first matrix describes the probability a feature belongs to a topic. We call this the feature-topic-matrix.</p>
<p><img src="media/lda-ftm.png" class="img-fluid"></p>
<p>The second table describes does the same, but with documents. We call this the document-term-matrix.</p>
<p><img src="media/lda-dtm.png" class="img-fluid"></p>
<p>This case makes it pretty clear: mice belong to the first topic, cats belong to the second, dogs belong to the third topic. The first document has a high probability to belong to the first topic, because it is full of mice. The second document has a high probability to belong to the second topic, because it is full of cats. The third document has a high probability to belong to the third topic, because it is full of dogs.</p>
<p>What makes LDA often seem magical, is how well it works for text. This is because the underlying assumptions fit the statistical features of document collections quite well, leading to meaningful and interpretable categories that make it easy to explore and summarise what is happening in text.</p>
<p>The short example above shows the three broad steps of topic modelling:</p>
<ol type="1">
<li>Create a document-feature-matrix from your documents (and preprocess it)</li>
<li>Fit the topic model</li>
<li>Analyze (and validate) the results</li>
</ol>
<p>Before we go on, here are a few things I want you to try:</p>
<ol type="1">
<li>Change the Alpha and Beta values</li>
<li>Add and replace your own text</li>
<li>Change the number of topics</li>
</ol>
</section>
<section id="obtaining-the-data" class="level1">
<h1>(0) Obtaining the data</h1>
<p>We use a subset of the Parlspeech corpus <span class="citation" data-cites="parlspeech2020">(<a href="#ref-parlspeech2020" role="doc-biblioref"><strong>parlspeech2020?</strong></a>)</span>, spanning the 18th legislative period of the Bundestag.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># note: I leave this here to show you how I processed the data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># after download from dataverse. The original file is not in the course material.</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>bundestag18 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/Corp_Bundestag_V2.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(date),</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>         <span class="at">speechnumber =</span> <span class="fu">as.integer</span>(speechnumber)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&gt;=</span> <span class="st">"2013-10-22"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>         date <span class="sc">&lt;=</span> <span class="st">"2017-10-24"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(bundestag18, <span class="st">"data/bundestag18_speeches.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(<span class="st">"data/bundestag18_speeches.rds"</span>)) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  curl<span class="sc">::</span><span class="fu">curl_download</span>(<span class="st">"https://www.dropbox.com/s/gn971s2ea3zbfgt/bundestag18_speeches.rds?dl=1"</span>, <span class="st">"data/bundestag18_speeches.rds"</span>, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>bundestag18 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/bundestag18_speeches.rds"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">doc_id =</span> <span class="fu">paste0</span>(date, <span class="st">"-"</span>, speechnumber)) <span class="sc">%&gt;%</span> </span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="creating-a-dtm" class="level1">
<h1>(1) Creating a DFM</h1>
<p>We first tidy the documents:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidytext)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>bundestag18_tidy <span class="ot">&lt;-</span> bundestag18 <span class="sc">%&gt;%</span> </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_tokens</span>(<span class="at">output =</span> word, <span class="at">input =</span> <span class="st">"text"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Secondly, we do some light cleaning:</p>
<ul>
<li>removing stopwords</li>
<li>lemmatisation</li>
<li>removing rare terms</li>
<li>removing features that aren’t words</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bundestag18_tidy_clean <span class="ot">&lt;-</span> bundestag18_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>word <span class="sc">%in%</span> <span class="fu">c</span>(stopwords<span class="sc">::</span><span class="fu">stopwords</span>(<span class="at">language =</span> <span class="st">"de"</span>), </span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"dass"</span>, <span class="st">"kollege"</span>, <span class="st">"kollegin"</span>, <span class="st">"herr"</span>, <span class="st">"frau"</span>, <span class="st">"dr"</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(word) <span class="sc">%&gt;%</span> </span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">n</span>() <span class="sc">&gt;</span> <span class="dv">10</span>,                    <span class="co"># keep features that appears more than 10 times</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span><span class="fu">str_detect</span>(word, <span class="st">"[^a-z]"</span>)  <span class="co"># keep features that consist only of characters</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span> </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"Cleaning removed {length(unique(bundestag18_tidy$word)) - length(unique(bundestag18_tidy_clean$word))} "</span>,</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"unique words and "</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{length(unique(bundestag18_tidy$doc_id)) - length(unique(bundestag18_tidy_clean$doc_id))} documents. "</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{length(unique(bundestag18_tidy$word))} unique words remain in "</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"{length(unique(bundestag18_tidy$doc_id))} documents"</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Cleaning removed 197068 unique words and 986 documents. 224189 unique words remain in 52784 documents</code></pre>
</div>
</div>
<p>Now we can create a document-feature-matrix. This is a (sparse) matrix showing how often each term (column) occurs in each document (row):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dfm <span class="ot">&lt;-</span> bundestag18_tidy_clean <span class="sc">%&gt;%</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(doc_id, word) <span class="sc">%&gt;%</span> </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cast_dfm</span>(doc_id, word, n)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can inspect a corner of the dtm by casting it to a regular (dense) matrix:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(bundestag18_dfm[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>               features
docs            abgeordnete abgeordneten abgeordneter abs abschluss
  2013-10-22-1            2            2            2   1         1
  2013-10-22-10           0            1            0   0         0
  2013-10-22-11           0            0            0   0         0
  2013-10-22-12           0            0            0   0         0
  2013-10-22-13           0            0            0   0         0</code></pre>
</div>
</div>
</section>
<section id="running-the-topic-model" class="level1">
<h1>(2) Running the topic model</h1>
<p>We can now fit the topic model from the dfm using the <code>textmodel_lda()</code> functin from the <code>seededlda</code> package. I like this package because of how simple and fast it is to use. In most tutorials use the <code>topicmodels</code> or <code>lda</code> package, which are also good. (stay away from <code>mallet</code>.) Note that we use <code>set.seed</code> to create reproducible results since topic modeling invlvoes random re-sampling (meaning each run will yield slighly different results).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(seededlda)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>lda_model <span class="ot">&lt;-</span> <span class="fu">textmodel_lda</span>(</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  bundestag18_dfm,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> k,                 <span class="co"># the number of topics is chosen at random for demonstration purposes</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">200</span>,        <span class="co"># I would not usually recommend that few iterations, it's just so it runs quicker here</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="dv">50</span> <span class="sc">/</span> k,        <span class="co"># these are the default values in the package</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta =</span> <span class="fl">0.1</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting LDA with 10 topics
   ...initializing
   ...Gibbs sampling in 200 itterations
   ...iteration 100
   ...iteration 200
   ...computing theta and phi
   ...complete</code></pre>
</div>
</div>
</section>
<section id="inspecting-and-analysing-the-results" class="level1">
<h1>(3) Inspecting and analysing the results</h1>
<section id="word-topic-probabilities" class="level2">
<h2 class="anchored" data-anchor-id="word-topic-probabilities">Word-topic probabilities</h2>
<p>We first check the feature-topic-matrix (it’s actually a topic-feature-matrix as rows and columns are swapped, but that doesn’t really matter). The ftm in this model, however, has 27121 columns (one for each input feature), which makes this impossible to go through. Rather, we look at the words with the highest values in each topic. The value in the ftm is referred to as <span class="math inline">\(\phi\)</span> (or phi) (other implementations of LDA confusingly name this <span class="math inline">\(\beta\)</span> (beta)). We extract and plot the highest phi values for all topics</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>bundestag18_ftm <span class="ot">&lt;-</span> lda_model<span class="sc">$</span>phi <span class="sc">%&gt;%</span> </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> <span class="co"># converting the matrix into a data.frame makes sure it plays nicely with the tidyverse</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"topic"</span>) <span class="sc">%&gt;%</span> <span class="co"># the topic names/numbers are stored in the row.names, I move them to a column</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">topic =</span> <span class="fu">fct_inorder</span>(topic)) <span class="sc">%&gt;%</span> <span class="co"># turn to factor to maintain the correct order</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>topic, <span class="at">names_to =</span> <span class="st">"word"</span>, <span class="at">values_to =</span> <span class="st">"phi"</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>topic_topwords_plot <span class="ot">&lt;-</span> bundestag18_ftm <span class="sc">%&gt;%</span> <span class="co"># turn to long for plotting</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(topic) <span class="sc">%&gt;%</span> <span class="co"># using group_by and slice_max, we keep only the top 10 values from each topic</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> phi, <span class="at">n =</span> <span class="dv">15</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># using reorder_within does some magic for a nicer plot</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">word =</span> tidytext<span class="sc">::</span><span class="fu">reorder_within</span>(word, <span class="at">by =</span> phi, <span class="at">within =</span> topic)) <span class="sc">%&gt;%</span> </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># from here on, we just make a bar plot with facets</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> phi, <span class="at">y =</span> word, <span class="at">fill =</span> topic)) <span class="sc">+</span>                               </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  tidytext<span class="sc">::</span><span class="fu">scale_y_reordered</span>() <span class="sc">+</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>topic, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>)</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>topic_topwords_plot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="7_unsupervised-learning_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="768"></p>
</div>
</div>
<p>Going forward, I would now name these topics. I found this particular format in a Excel sheet helpful.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>lda_model<span class="sc">$</span>phi <span class="sc">%&gt;%</span> </span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rowid_to_column</span>(<span class="st">"topic"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>topic, <span class="at">names_to =</span> <span class="st">"word"</span>, <span class="at">values_to =</span> <span class="st">"phi"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(topic) <span class="sc">%&gt;%</span> </span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> phi, <span class="at">n =</span> <span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">top =</span> <span class="fu">row_number</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">id_cols =</span> top, <span class="at">names_from =</span> topic, <span class="at">values_from =</span> word) <span class="sc">%&gt;%</span> </span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Add an extra row where you can write in topic names</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_row</span>(<span class="at">top =</span> <span class="cn">NA</span>, <span class="at">.before =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  rio<span class="sc">::</span><span class="fu">export</span>(<span class="st">"7._topicsmodel_topwords.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="topics-per-document" class="level2">
<h2 class="anchored" data-anchor-id="topics-per-document">Topics per document</h2>
<p>Similary to above, we can also extract to topics per document:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm <span class="ot">&lt;-</span> lda_model<span class="sc">$</span>theta <span class="sc">%&gt;%</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as.data.frame</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rownames_to_column</span>(<span class="st">"doc_id"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 51,798 × 11
   doc_id topic1 topic2 topic3 topic4 topic5 topic6 topic7 topic8 topic9 topic10
   &lt;chr&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;
 1 2013-… 0.0853 0.0593 0.0621 0.343  0.0297 0.0195 0.0482 0.0834 0.235   0.0343
 2 2013-… 0.263  0.0421 0.0281 0.109  0.196  0.0491 0.0526 0.0386 0.116   0.105 
 3 2013-… 0.0980 0.0980 0.118  0.0980 0.0980 0.0980 0.0980 0.0980 0.0980  0.0980
 4 2013-… 0.1    0.0875 0.075  0.1    0.112  0.162  0.0625 0.075  0.162   0.0625
 5 2013-… 0.0909 0.0909 0.145  0.0909 0.0909 0.0909 0.0909 0.0909 0.0909  0.127 
 6 2013-… 0.245  0.0745 0.0266 0.0426 0.0904 0.0691 0.0745 0.0479 0.144   0.186 
 7 2013-… 0.0943 0.0943 0.113  0.0943 0.0943 0.0943 0.0943 0.0943 0.0943  0.132 
 8 2013-… 0.301  0.0725 0.0362 0.0761 0.101  0.127  0.0290 0.0362 0.109   0.112 
 9 2013-… 0.0639 0.0414 0.0789 0.0414 0.128  0.0677 0.0451 0.0301 0.0526  0.451 
10 2013-… 0.103  0.0841 0.112  0.0748 0.131  0.0654 0.0654 0.0654 0.0561  0.243 
# ℹ 51,788 more rows</code></pre>
</div>
</div>
<p>We can tidy this and join the results back with the original metadata using the <code>doc_id</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm_tidy <span class="ot">&lt;-</span> bundestag18_dtm <span class="sc">%&gt;%</span> </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>doc_id, <span class="at">names_to =</span> <span class="st">"topic"</span>, <span class="at">values_to =</span> <span class="st">"theta"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># again this is to keep track of the order as it is otherwise order by alphabet</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">topic =</span> <span class="fu">fct_inorder</span>(topic)) <span class="sc">%&gt;%</span> </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(bundestag18 <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>text), <span class="at">by =</span> <span class="st">"doc_id"</span>)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm_tidy</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 517,980 × 13
   doc_id       topic    theta date       agenda      speechnumber speaker party
   &lt;chr&gt;        &lt;fct&gt;    &lt;dbl&gt; &lt;date&gt;     &lt;chr&gt;              &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;
 1 2013-10-22-1 topic1  0.0853 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 2 2013-10-22-1 topic2  0.0593 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 3 2013-10-22-1 topic3  0.0621 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 4 2013-10-22-1 topic4  0.343  2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 5 2013-10-22-1 topic5  0.0297 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 6 2013-10-22-1 topic6  0.0195 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 7 2013-10-22-1 topic7  0.0482 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 8 2013-10-22-1 topic8  0.0834 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
 9 2013-10-22-1 topic9  0.235  2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
10 2013-10-22-1 topic10 0.0343 2013-10-22 SITZUNGSBE…            1 Heinz … &lt;NA&gt; 
# ℹ 517,970 more rows
# ℹ 5 more variables: party.facts.id &lt;dbl&gt;, chair &lt;lgl&gt;, terms &lt;dbl&gt;,
#   parliament &lt;chr&gt;, iso3country &lt;chr&gt;</code></pre>
</div>
</div>
<p>Now, we can e.g.&nbsp;compare topic usage per party:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm_tidy <span class="sc">%&gt;%</span>  </span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(party),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>         party <span class="sc">!=</span> <span class="st">"independent"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(party, topic) <span class="sc">%&gt;%</span>  </span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">theta =</span> <span class="fu">mean</span>(theta)) <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> theta, <span class="at">y =</span> topic, <span class="at">fill =</span> party)) <span class="sc">+</span> </span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="at">position =</span> <span class="st">"dodge"</span>)  <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"PDS/LINKE"</span> <span class="ot">=</span> <span class="st">"#BD3075"</span>,</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SPD"</span> <span class="ot">=</span> <span class="st">"#D71F1D"</span>,</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"GRUENE"</span> <span class="ot">=</span> <span class="st">"#78BC1B"</span>,</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"CDU/CSU"</span> <span class="ot">=</span> <span class="st">"#121212"</span>,</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"FDP"</span> <span class="ot">=</span> <span class="st">"#FFCC00"</span>,</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">"AfD"</span> <span class="ot">=</span> <span class="st">"#4176C2"</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="7_unsupervised-learning_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>What sticks out is how often the AfD uses topic one.</p>
<p>Or over time:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">date =</span> <span class="fu">floor_date</span>(date, <span class="st">"months"</span>), topic) <span class="sc">%&gt;%</span>  </span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">theta =</span> <span class="fu">mean</span>(theta)) <span class="sc">%&gt;%</span> </span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> theta, <span class="at">colour =</span> topic)) <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="7_unsupervised-learning_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>bundestag18_dtm_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(<span class="at">date =</span> <span class="fu">floor_date</span>(date, <span class="st">"months"</span>), topic) <span class="sc">%&gt;%</span>  </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">theta =</span> <span class="fu">mean</span>(theta)) <span class="sc">%&gt;%</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> theta, <span class="at">colour =</span> topic)) <span class="sc">+</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="fu">vars</span>(topic))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="7_unsupervised-learning_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Again, topic 1 seems quite special with an explosion of prevalence in the second half of 2015.</p>
</section>
<section id="some-alternative-ways-to-explore-the-model" class="level2">
<h2 class="anchored" data-anchor-id="some-alternative-ways-to-explore-the-model">Some alternative ways to explore the model</h2>
<section id="ldavis" class="level3">
<h3 class="anchored" data-anchor-id="ldavis">LDAvis</h3>
<p>A popular way of exploring topics and how they overlap is the <code>LDAvis</code> package.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(LDAvis)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>json <span class="ot">&lt;-</span> <span class="fu">createJSON</span>(<span class="at">phi =</span> lda_model<span class="sc">$</span>phi,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">theta =</span> lda_model<span class="sc">$</span>theta, </span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">doc.length =</span> quanteda<span class="sc">::</span><span class="fu">ntoken</span>(lda_model<span class="sc">$</span>data),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">vocab =</span> quanteda<span class="sc">::</span><span class="fu">featnames</span>(lda_model<span class="sc">$</span>data), </span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">term.frequency =</span> quanteda<span class="sc">::</span><span class="fu">featfreq</span>(lda_model<span class="sc">$</span>data))</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="fu">serVis</span>(json)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>LDAvis helps users understand the relationships between topics and the key terms that define them.</p>
<p>The LDAvis visualization consists of two main components:</p>
<ol type="1">
<li>Intertopic Distance Map: This is a two-dimensional plot displaying the distribution of topics. Each topic is represented by a circle, and its size indicates the relative prevalence of the topic in the corpus (important: the number inside the circle is not the topic number we used above! LDAvis assigns 1 to the larges topic, 2 is the second largest et.c). The distance between the circles represents the similarity or dissimilarity between topics. Topics that are closer together share more common terms, while topics further apart are more distinct.</li>
<li>Top-Ranking Terms: This panel shows the most relevant terms for a selected topic. Relevance is determined by a combination of term frequency within the topic and the term’s distinctiveness across topics. By examining the top-ranking terms, users can gain insights into the thematic content of each topic. If no topic is selected, it displays the overall salience of words.</li>
</ol>
<p>To interpret the LDAvis visualization, follow these steps:</p>
<ol type="1">
<li>Examine the Intertopic Distance Map to understand the overall topic structure. Look for clusters of closely related topics or distinct groups of unrelated topics. Click on a topic circle to view the Top-Ranking Terms for that topic in the right panel. Assess the terms to infer the underlying theme or subject matter of the topic. Adjust the relevance metric (usually denoted by λ) to emphasize either term frequency within the topic or distinctiveness across topics, depending on your analysis goals. Repeat steps 2-3 for other topics to gain a comprehensive understanding of the thematic structure of your corpus. By leveraging LDAvis, users can efficiently interpret LDA-generated topics and gain valuable insights into the underlying structure and themes of large text corpora.</li>
</ol>
</section>
<section id="tokenbrowser" class="level3">
<h3 class="anchored" data-anchor-id="tokenbrowser"><code>tokenbrowser</code></h3>
<p>We can check how the probabilities for documents are calculated by looking at the words and topic probabilities in their original context using the using the <a href="https://github.com/kasperwelbers/tokenbrowser">tokenbrowser</a> package developed by Kasper Welbers</p>
<p>We first select the 2000 tokens with the highest phi value, i.e., the ones which most clearly belong to one topic.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>categories <span class="ot">&lt;-</span> bundestag18_ftm <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(word) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">phi_rel =</span> phi <span class="sc">/</span> <span class="fu">sum</span>(phi)) <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(<span class="at">order_by =</span> phi, <span class="at">n =</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(phi_rel <span class="sc">&gt;=</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we attach the categories to the original tidy representation of the texts.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>assignments <span class="ot">&lt;-</span> bundestag18_tidy <span class="sc">%&gt;%</span> </span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(doc_id <span class="sc">%in%</span> <span class="fu">unique</span>(bundestag18_tidy<span class="sc">$</span>doc_id)[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>]) <span class="sc">%&gt;%</span> </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(categories, <span class="at">by =</span> <span class="st">"word"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can look at the words that clearly belong to a topic in context of the full speeches.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tokenbrowser)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">categorical_browser</span>(</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  assignments,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">category =</span> <span class="fu">as.factor</span>(assignments<span class="sc">$</span>topic), </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">token_col =</span> <span class="st">"word"</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">browseURL</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
</section>
<section id="finding-an-optimal-number-of-topics" class="level1">
<h1>Finding an optimal number of topics</h1>
<p>The best way to find the optimal <span class="math inline">\(k\)</span> number of topics is to interpret different models and look for the ones that seems to divide your corpus into the most meaningful topics. However, this can be very cumbersome and there are some statistical methods to make the process easier. The idea behind all of them is to compare the metrics of different models to narrow your search down.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>lda_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(k, <span class="at">max_iter =</span> <span class="dv">20</span>) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">textmodel_lda</span>(</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>    bundestag18_dfm,</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">k =</span> k,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter =</span> max_iter,</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">alpha =</span> <span class="dv">50</span> <span class="sc">/</span> k,</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">beta =</span> <span class="fl">0.1</span>,</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">verbose =</span> <span class="cn">TRUE</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>models_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">k =</span> <span class="fu">c</span>(<span class="dv">10</span><span class="sc">:</span><span class="dv">20</span>),</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">map</span>(k, lda_fun)</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Fitting LDA with 10 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 11 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 12 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 13 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 14 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 15 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 16 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 17 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 18 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 19 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete
Fitting LDA with 20 topics
   ...initializing
   ...Gibbs sampling in 20 itterations
   ...computing theta and phi
   ...complete</code></pre>
</div>
</div>
<p>There is no official function in <code>seededlda</code> to evaluate different models. The <code>stm</code> package is much better here <a href="https://juliasilge.com/blog/evaluating-stm/">as demonstrated by Julia Silge</a>. But since I did not want to introduce another package, I copied the functions that are currently discussed from <a href="https://github.com/koheiw/seededlda/issues/26">this issue on GitHub</a>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>semantic_coherence <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">top_n =</span> <span class="dv">10</span>) {</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    h <span class="ot">&lt;-</span> <span class="fu">apply</span>(<span class="fu">terms</span>(model, top_n), <span class="dv">2</span>, <span class="cf">function</span>(y) {</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        d <span class="ot">&lt;-</span> model<span class="sc">$</span>data[,y]</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>        e <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">Matrix</span>(<span class="fu">docfreq</span>(d), <span class="at">nrow =</span> <span class="fu">nfeat</span>(d), <span class="at">ncol =</span> <span class="fu">nfeat</span>(d))</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>        f <span class="ot">&lt;-</span> <span class="fu">fcm</span>(d, <span class="at">count =</span> <span class="st">"boolean"</span>) <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        g <span class="ot">&lt;-</span> Matrix<span class="sc">::</span><span class="fu">band</span>(<span class="fu">log</span>(f <span class="sc">/</span> e), <span class="dv">1</span>, <span class="fu">ncol</span>(f))</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sum</span>(g)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(h)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>divergence <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    div <span class="ot">&lt;-</span> proxyC<span class="sc">::</span><span class="fu">dist</span>(model<span class="sc">$</span>phi, <span class="at">method =</span> <span class="st">"kullback"</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">diag</span>(div) <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">as.matrix</span>(div), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a><span class="co"># this one is taken from stm https://github.com/bstewart/stm/blob/master/R/exclusivity.R</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>exclusivity <span class="ot">&lt;-</span> <span class="cf">function</span>(model, <span class="at">top_n =</span> <span class="dv">10</span>, <span class="at">frexw =</span> <span class="fl">0.7</span>) {</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>  tphi <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">exp</span>(model<span class="sc">$</span>phi))</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a>  s <span class="ot">&lt;-</span> <span class="fu">rowSums</span>(tphi)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a>  mat <span class="ot">&lt;-</span> tphi <span class="sc">/</span> s <span class="co"># normed by columns of beta now.</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a>  ex <span class="ot">&lt;-</span> <span class="fu">apply</span>(mat, <span class="dv">2</span>, rank) <span class="sc">/</span> <span class="fu">nrow</span>(mat)</span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a>  fr <span class="ot">&lt;-</span> <span class="fu">apply</span>(tphi, <span class="dv">2</span>, rank) <span class="sc">/</span> <span class="fu">nrow</span>(mat)</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>  frex <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (frexw <span class="sc">/</span> ex <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> frexw) <span class="sc">/</span> fr)</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a>  index <span class="ot">&lt;-</span> <span class="fu">apply</span>(tphi, <span class="dv">2</span>, order, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>top_n, ]</span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="at">length =</span> <span class="fu">ncol</span>(tphi))</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">ncol</span>(frex))) {</span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a>    out[i] <span class="ot">&lt;-</span> <span class="fu">sum</span>(frex[index[, i], i])</span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">mean</span>(out))</span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can now use this plot to evaluate the different models.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>models_df_metrics <span class="ot">&lt;-</span> models_df <span class="sc">%&gt;%</span> </span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">semantic_coherence =</span> <span class="fu">map_dbl</span>(model, semantic_coherence),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>         <span class="at">exclusivity =</span> <span class="fu">map_dbl</span>(model, exclusivity),</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>         <span class="at">divergence =</span> <span class="fu">map_dbl</span>(model, divergence))</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>models_df_metrics <span class="sc">%&gt;%</span> </span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>model) <span class="sc">%&gt;%</span> </span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="sc">-</span>k, <span class="at">names_to =</span> <span class="st">"metric"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> k, value, <span class="at">color =</span> metric)) <span class="sc">+</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">alpha =</span> <span class="fl">0.7</span>, <span class="at">show.legend =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_x_continuous</span>(<span class="at">breaks =</span> scales<span class="sc">::</span><span class="fu">pretty_breaks</span>()) <span class="sc">+</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>metric, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">"K (number of topics)"</span>,</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>       <span class="at">y =</span> <span class="cn">NULL</span>,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>       <span class="at">title =</span> <span class="st">"Model diagnostics by number of topics"</span>,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">subtitle =</span> <span class="st">"Higher = Better"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="7_unsupervised-learning_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>heavily influenced by this piece: https://medium.com/<span class="citation" data-cites="lettier/how-does-lda-work-ill-explain-using-emoji-108abf40fa7d">(<a href="#ref-lettier/how-does-lda-work-ill-explain-using-emoji-108abf40fa7d" role="doc-biblioref"><strong>lettier/how-does-lda-work-ill-explain-using-emoji-108abf40fa7d?</strong></a>)</span><a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>